## 설치 ##

```
$ sudo yum install metricbeat
```

## 설정 ##

https://www.elastic.co/guide/en/beats/metricbeat/current/metricbeat-configuration.html

키바나 및 일라스틱서치의 URL 을 등록하기 위해 metricbeat.yml 파일을 아래와 같이 설정한다. 

각종 모듈에 대한 설정은 metricbeat.yml 파일에 등록은 할 수 있으나,

/etc/metricbeat/modules.d 디렉토리에서 모듈별로 yml 설정 파일이 존재하는 경우 해당 디렉토리의 설정이 우선시 된다. 

```
$ sudo vi /etc/metricbeats/metricbeat.yml

57 #============================== Kibana =====================================
58
59 # Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.
60 # This requires a Kibana endpoint configuration.
61 setup.kibana:
62
63   # Kibana Host
64   # Scheme and port can be left out and will be set to the default (http and 5601)
65   # In case you specify and additional path, the scheme is required: http://localhost:5601/path
66   # IPv6 addresses should always be defined as: https://[2001:db8::1]:5601
67   host: "localhost:5601"
68
69   # Kibana Space ID
70   # ID of the Kibana Space into which the dashboards should be loaded. By default,
71   # the Default Space will be used.
72   #space.id:


87 #================================ Outputs =====================================
88
89 # Configure what output to use when sending the data collected by the beat.
90
91 #-------------------------- Elasticsearch output ------------------------------
92 output.elasticsearch:
93   # Array of hosts to connect to.
94   hosts: ["localhost:9200"]
95
96   # Enabled ilm (beta) to use index lifecycle management instead daily indices.
97   #ilm.enabled: false
98
99   # Optional protocol and basic auth credentials.
100   #protocol: "https"
101   #username: "elastic"
102   #password: "changeme"
103


119 #================================ Processors =====================================
120
121 # Configure processors to enhance or manipulate events generated by the beat.
122
123 #processors:
124 #  - add_host_metadata: ~
125 #  - add_cloud_metadata: ~

```
위와 같이 키바나 및 elasticsearch 엔드포인트를 등록하고, Processors 부분은 코멘트 처리한다. 


```
$ cd /etc/metricbeat/modules.d
$ vi system.yml

- module: system
  period: 300s
  metricsets:
    - cpu
    - load
    - memory
    - network
#    - process
#    - process_summary
#    - socket_summary
    #- core
    - diskio
    #- socket
  process.include_top_n:
    by_cpu: 5      # include top 5 processes by CPU
    by_memory: 5   # include top 5 processes by memory

- module: system
  period: 1m
  metricsets:
    - filesystem
    - fsstat
  processors:
  - drop_event.when.regexp:
      system.filesystem.mount_point: '^/(sys|cgroup|proc|dev|etc|host|lib)($|/)'

- module: system
  period: 15m
  metricsets:
    - uptime

#- module: system
#  period: 5m
#  metricsets:
#    - raid
#  raid.mount_point: '/'
```
system.yml 파일에 시스템과 관련된 메트릭 수집 정보를 설정한다.


* mysql 에 대한 모니터링을 활성화 하고자 하는 경우 

```
$ sudo metricbeat modules enable mysql
Enabled mysql

$ pwd
/etc/metricbeat/modules.d
$ ls -la
합계 144
drwxr-xr-x 2 root root 4096  5월 29 22:15 .
drwxr-xr-x 3 root root   95  5월 29 22:00 ..
-rw-r--r-- 1 root root  203  5월 16 04:15 memcached.yml.disabled
-rw-r--r-- 1 root root 1170  5월 16 04:15 mongodb.yml.disabled
-rw-r--r-- 1 root root  215  5월 16 04:15 munin.yml.disabled
-rw-r--r-- 1 root root  580  5월 16 04:15 mysql.yml
-rw-r--r-- 1 root root  771  5월 29 22:12 system.yml
-rw-r--r-- 1 root root  196  5월 16 04:15 traefik.yml.disabled
-rw-r--r-- 1 root root  200  5월 16 04:15 uwsgi.yml.disabled
-rw-r--r-- 1 root root  478  5월 16 04:15 vsphere.yml.disabled
-rw-r--r-- 1 root root  736  5월 16 04:15 windows.yml.disabled
-rw-r--r-- 1 root root  218  5월 16 04:15 zookeeper.yml.disabled
```

modules.d 디렉토리의 파일 리스트를 조회하면 mysql.yml 과 system.yml 파일을 확인할 수 있다.

모니터링이 off 된 메트릭은 파일명이 disabled 로 끝난다. 




## 에러 발생시 로그 확인 ##
```
$ sudo journalctl -u metricbeat

5월 29 20:23:33 startup systemd[1]: metricbeat.service: main process exited, code=exited, status=1/FAILURE
5월 29 20:23:33 startup systemd[1]: Unit metricbeat.service entered failed state.
5월 29 20:23:33 startup systemd[1]: metricbeat.service failed.
5월 29 20:23:33 startup systemd[1]: metricbeat.service holdoff time over, scheduling restart.
5월 29 20:23:33 startup systemd[1]: Stopped Metricbeat is a lightweight shipper for metrics..
5월 29 20:23:33 startup systemd[1]: Started Metricbeat is a lightweight shipper for metrics..
5월 29 20:23:33 startup metricbeat[26737]: Exiting: error loading config file: yaml: line 49: mapping values are not allowed in this context

```



## elasticsearch index  ##

```
$ curl localhost:9200/_cat/indices?v | grep metricbeat

 % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 12573  100 12573yellow open   metricbeat-6.8.0-2019.05.29     BlphpxapQZmN0_VHu-d1wg   1   1        145            0    547.9kb        547.9kb
    0     0   109k      0 --:--:-- --:--:-- --:--:--  110k
```


## 키바나 대시보드 설치 ##

```
$ sudo metricbeat setup --dashboards
Loading dashboards (Kibana must be running and reachable)

Loaded dashboards
```

대시 보드를 설치하는 경우 기존에 키바나에 등록되어진 대시보드는 지워지므로, 설치후 명칭을 변경하도록 한다.


## 카프카 연동 ##

https://stackoverflow.com/questions/56233663/metricbeat-kafka-logstash-configuration


메트릭비트(서버) ---> 카프카 스트링 ---> logstash ---> elasticsearch.


## 레퍼런스 ##

https://www.server-world.info/en/note?os=CentOS_7&p=elasticstack6&f=5
